@page "/admin/albums/{Id:int}"
@using Whitestone.SegnoSharp.Database.Models
@using Microsoft.AspNetCore.Mvc.Diagnostics
@using Whitestone.SegnoSharp.Database.Extensions
@attribute [Authorize]

@if (Album == null)
{
    <h1 style="color: red">Album not found</h1>
    return;
}

<h1>Edit album</h1>

<div>
    Added: <em>@Album.Added</em>
</div>

<div style="float: left;margin-right: 20px;">
    <h2>Album data</h2>
    <table class="Editor">
        <tr>
            <th>Title:</th>
            <td><input @bind="Album.Title" /></td>
        </tr>
        <tr>
            <th>Published:</th>
            <td><input @bind="Album.Published" /></td>
        </tr>
        <tr>
            <th>Genres:</th>
            <td>
                <TagList Items="Album.Genres" ExecuteSearch="ExecuteGenreSearch" />
            </td>
        </tr>
        <tr>
            <th>Record labels:</th>
            <td>
                <TagList Items="Album.RecordLabels" ExecuteSearch="ExecuteRecordLabelSearch"/>
            </td>
        </tr>
        <tr>
            <th>UPC:</th>
            <td><input @bind="Album.Upc" /></td>
        </tr>
        <tr>
            <th>Catalogue Number:</th>
            <td><input @bind="Album.CatalogueNumber" /></td>
        </tr>
        <tr>
            <th>Public:</th>
            <td><input type="checkbox" @bind="Album.IsPublic" /></td>
        </tr>
    </table>
</div>
<div style="float: left; margin-right: 20px;">
    <h2>People</h2>

    <table>
        @foreach (AlbumPersonGroupPersonRelation personGroupRelation in Album.AlbumPersonGroupPersonRelations.OrderBy(r => r.PersonGroup.SortOrder))
        {
            <tr>
                <th>@personGroupRelation.PersonGroup.Name <button title="Remove @personGroupRelation.PersonGroup.Name group" class="TinyDelete" @onclick="() => RemovePersonGroup(personGroupRelation)"><span class="fa-regular fa-circle-xmark"></span></button>:</th>
                <td>
                    <TagList Items="@personGroupRelation.Persons" ExecuteSearch="ExecutePersonSearch"></TagList>
                </td>
            </tr>
        }

        @{
            List<PersonGroup> personGroups = PersonGroups
            .Where(pg => Album.AlbumPersonGroupPersonRelations.All(apg => apg.PersonGroup.Id != pg.Id))
            .ToList();

            if (personGroups.Any())
            {
                <tr>
                    <th>Add group:</th>
                    <td>
                        <select @bind="SelectedPersonGroupId">
                            <option value="-1"></option>
                            @foreach (PersonGroup personGroup in personGroups)
                            {
                                <option value="@personGroup.Id">@personGroup.Name</option>
                            }
                        </select>
                        <button @onclick="AddPersonGroup" disabled="@(SelectedPersonGroupId <= 0)">Add</button>
                    </td>
                </tr>
            }
        }
    </table>
</div>
<div style="float: left;">
    <h2>Cover</h2>
    @if (Album.AlbumCover != null)
    {
        <div>
            <img style="max-width: 250px;" src="@Album.AlbumCover.ToInlineBase64()" alt="Album cover" />
        </div>
        <div>
            <button @onclick="RemoveAlbumCover">Remove</button>
        </div>
    }
    else
    {
        <div>
            <InputFile OnChange="AddAlbumCover" accept=".jpg,.jpeg,image/jpeg,.png,image/png" />
        </div>
        @if (AlbumCoverFileSizeError)
        {
            <div class="Error">Image is too large. Max image size is 5MB.</div>
        }
    }
</div>

<div style="clear: both;">
    <button @onclick="Save">Save</button>
</div>